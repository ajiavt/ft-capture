<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Area Selection</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            overflow: hidden;
            user-select: none;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #007AFF;
            background: rgba(0, 122, 255, 0.1);
            pointer-events: none;
        }

        .instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            z-index: 1000;
            text-align: center;
        }

        .coordinates {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        .macro-info {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 122, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="instructions">
        ðŸ“· Click to select start point â€¢ ESC to cancel
    </div>

    <div class="macro-info" id="macro-info">
        Setting area for: <span id="macro-name">Loading...</span>
    </div>

    <div class="coordinates" id="coordinates" style="display: none;">
        X: 0, Y: 0, W: 0, H: 0
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const Store = require('electron-store');
        const store = new Store();

        let selectionState = 'waiting'; // 'waiting', 'selecting', 'selected'
        let startX, startY, endX, endY;
        let selectionBox;
        let coordinatesDiv = document.getElementById('coordinates');
        let currentMacroId = null;

        // Load current macro info
        document.addEventListener('DOMContentLoaded', () => {
            currentMacroId = store.get('currentMacroId');
            if (currentMacroId) {
                const macros = store.get('macros', []);
                const macro = macros.find(m => m.id === currentMacroId);
                if (macro) {
                    document.getElementById('macro-name').textContent = macro.name;
                }
            }
        });

        // Mouse events for area selection
        document.addEventListener('click', handleClick);
        document.addEventListener('mousemove', updateSelection);
        document.addEventListener('keydown', handleKeydown);

        function handleClick(e) {
            if (selectionState === 'waiting') {
                // First click - set start point
                startSelection(e);
            } else if (selectionState === 'selecting') {
                // Second click - set end point
                endSelection(e);
            } else if (selectionState === 'selected') {
                // Click to start over
                resetSelection();
            }
        }

        function startSelection(e) {
            selectionState = 'selecting';
            startX = e.clientX;
            startY = e.clientY;

            // Create selection box
            selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box';
            document.body.appendChild(selectionBox);

            // Show coordinates
            coordinatesDiv.style.display = 'block';

            // Update instructions
            document.querySelector('.instructions').innerHTML = 'ðŸ“· Click to set end point â€¢ Enter to confirm â€¢ ESC to cancel';

            updateCoordinatesDisplay();
        }

        function updateSelection(e) {
            if (selectionState !== 'selecting' || !selectionBox) return;

            endX = e.clientX;
            endY = e.clientY;

            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';

            // Update coordinates display
            coordinatesDiv.style.left = (e.clientX + 10) + 'px';
            coordinatesDiv.style.top = (e.clientY - 30) + 'px';
            updateCoordinatesDisplay();
        }

        function updateCoordinatesDisplay() {
            if (selectionState === 'waiting') return;

            const left = Math.min(startX, endX || startX);
            const top = Math.min(startY, endY || startY);
            const width = Math.abs((endX || startX) - startX);
            const height = Math.abs((endY || startY) - startY);

            coordinatesDiv.textContent = `X: ${left}, Y: ${top}, W: ${width}, H: ${height}`;
        }

        function endSelection(e) {
            if (selectionState !== 'selecting') return;

            selectionState = 'selected';
            endX = e.clientX;
            endY = e.clientY;

            // Update selection box one final time
            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';

            // Change selection box style to show it's finalized
            selectionBox.style.borderColor = '#34C759';
            selectionBox.style.background = 'rgba(52, 199, 89, 0.2)';

            // Update instructions
            document.querySelector('.instructions').innerHTML = 'âœ… Area selected â€¢ Enter to confirm â€¢ ESC to cancel â€¢ Click to start over';

            updateCoordinatesDisplay();
        }

        function confirmSelection() {
            if (selectionState !== 'selected' || !currentMacroId) return;

            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            // Minimum size check
            if (width < 10 || height < 10) {
                alert('Selection area too small. Please select a larger area.');
                resetSelection();
                return;
            }

            // Get screen position (account for multiple displays)
            const { screen } = require('electron');
            const display = screen.getDisplayNearestPoint({x: left, y: top});

            const area = {
                x: left + display.bounds.x,
                y: top + display.bounds.y,
                width: width,
                height: height
            };

            // Update macro with area
            const macros = store.get('macros', []);
            const macroIndex = macros.findIndex(m => m.id === currentMacroId);
            if (macroIndex !== -1) {
                macros[macroIndex].area = area;
                store.set('macros', macros);

                // Notify main process
                ipcRenderer.send('macro-area-assigned', currentMacroId, area);

                // Close overlay
                window.close();
            }
        }

        function resetSelection() {
            if (selectionBox) {
                selectionBox.remove();
                selectionBox = null;
            }
            coordinatesDiv.style.display = 'none';
            selectionState = 'waiting';

            // Reset instructions
            document.querySelector('.instructions').innerHTML = 'ðŸ“· Click to select start point â€¢ ESC to cancel';
        }

        function cancelSelection() {
            resetSelection();
            // Close overlay
            window.close();
        }

        function handleKeydown(e) {
            if (e.key === 'Escape') {
                if (selectionState === 'waiting') {
                    cancelSelection();
                } else {
                    resetSelection();
                }
            } else if (e.key === 'Enter' && selectionState === 'selected') {
                confirmSelection();
            }
        }

        // Auto-focus for keyboard events
        window.focus();

        // Handle window close
        window.addEventListener('beforeunload', () => {
            ipcRenderer.send('area-selection-cancelled');
        });
    </script>
</body>
</html>
