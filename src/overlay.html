<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Area Selection</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            overflow: hidden;
            user-select: none;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #007AFF;
            background: rgba(0, 122, 255, 0.1);
            pointer-events: none;
        }

        .instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            z-index: 1000;
            text-align: center;
        }

        .coordinates {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        .macro-info {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 122, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            z-index: 1000;
            text-align: center;
        }

        .action-buttons {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 15px;
            z-index: 1000;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .confirm-btn {
            background: #34C759;
            color: white;
        }

        .confirm-btn:hover {
            background: #2EA043;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background: #FF3B30;
            color: white;
        }

        .cancel-btn:hover {
            background: #D32F2F;
            transform: translateY(-1px);
        }

        .restart-btn {
            background: #FF9500;
            color: white;
        }

        .restart-btn:hover {
            background: #E8820E;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="instructions">
        üì∑ Click to select start point ‚Ä¢ ESC to cancel
    </div>

    <div class="macro-info" id="macro-info">
        Setting area for: <span id="macro-name">Loading...</span>
    </div>

    <div class="coordinates" id="coordinates" style="display: none;">
        X: 0, Y: 0, W: 0, H: 0
    </div>

    <div class="action-buttons" id="action-buttons">
        <button class="action-btn confirm-btn" onclick="confirmSelection()">‚úÖ Confirm Area</button>
        <button class="action-btn restart-btn" onclick="resetSelection()">üîÑ Start Over</button>
        <button class="action-btn cancel-btn" onclick="cancelSelection()">‚ùå Cancel</button>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const Store = require('electron-store');
        const store = new Store();

        let selectionState = 'waiting'; // 'waiting', 'selecting', 'selected'
        let startX, startY, endX, endY;
        let selectionBox;
        let coordinatesDiv = document.getElementById('coordinates');
        let actionButtons = document.getElementById('action-buttons');
        let currentMacroId = null;

        // Load current macro info
        document.addEventListener('DOMContentLoaded', () => {
            currentMacroId = store.get('currentMacroId');
            if (currentMacroId) {
                const macros = store.get('macros', []);
                const macro = macros.find(m => m.id === currentMacroId);
                if (macro) {
                    document.getElementById('macro-name').textContent = macro.name;
                }
            }
        });

        // Mouse events for area selection
        document.addEventListener('click', handleClick);
        document.addEventListener('mousemove', updateSelection);
        document.addEventListener('keydown', handleKeydown);

        function handleClick(e) {
            // Skip if clicking on buttons
            if (e.target.classList.contains('action-btn')) {
                return;
            }

            if (selectionState === 'waiting') {
                // First click - set start point
                startSelection(e);
            } else if (selectionState === 'selecting') {
                // Second click - set end point
                endSelection(e);
            }
        }

        function startSelection(e) {
            selectionState = 'selecting';
            startX = e.clientX;
            startY = e.clientY;

            // Create selection box
            selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box';
            document.body.appendChild(selectionBox);

            // Show coordinates
            coordinatesDiv.style.display = 'block';

            // Update instructions
            document.querySelector('.instructions').innerHTML = 'üì∑ Click to set end point ‚Ä¢ ESC to cancel';

            updateCoordinatesDisplay();
        }

        function updateSelection(e) {
            if (selectionState !== 'selecting' || !selectionBox) return;

            endX = e.clientX;
            endY = e.clientY;

            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';

            // Update coordinates display
            coordinatesDiv.style.left = (e.clientX + 10) + 'px';
            coordinatesDiv.style.top = (e.clientY - 30) + 'px';
            updateCoordinatesDisplay();
        }

        function updateCoordinatesDisplay() {
            if (selectionState === 'waiting') return;

            const left = Math.min(startX, endX || startX);
            const top = Math.min(startY, endY || startY);
            const width = Math.abs((endX || startX) - startX);
            const height = Math.abs((endY || startY) - startY);

            coordinatesDiv.textContent = `X: ${left}, Y: ${top}, W: ${width}, H: ${height}`;
        }

        function endSelection(e) {
            if (selectionState !== 'selecting') return;

            selectionState = 'selected';
            endX = e.clientX;
            endY = e.clientY;

            // Update selection box one final time
            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';

            // Change selection box style to show it's finalized
            selectionBox.style.borderColor = '#34C759';
            selectionBox.style.background = 'rgba(52, 199, 89, 0.2)';

            // Update instructions and show action buttons
            document.querySelector('.instructions').innerHTML = '‚úÖ Area selected ‚Ä¢ Choose action below';
            actionButtons.style.display = 'flex';

            updateCoordinatesDisplay();
        }

        function confirmSelection() {
            // Send log to main process so it appears in WebStorm terminal
            ipcRenderer.send('debug-log', '=== CONFIRM SELECTION START ===');
            ipcRenderer.send('debug-log', 'Selection state: ' + selectionState);
            ipcRenderer.send('debug-log', 'Current macro ID: ' + currentMacroId);

            if (selectionState !== 'selected' || !currentMacroId) {
                ipcRenderer.send('debug-log', 'ERROR: Invalid state or missing macro ID');
                ipcRenderer.send('debug-log', '- selectionState should be "selected", got: ' + selectionState);
                ipcRenderer.send('debug-log', '- currentMacroId should exist, got: ' + currentMacroId);
                return;
            }

            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            ipcRenderer.send('debug-log', 'Area coordinates calculated: ' + JSON.stringify({ left, top, width, height }));

            // Minimum size check
            if (width < 10 || height < 10) {
                ipcRenderer.send('debug-log', 'ERROR: Area too small: ' + width + 'x' + height);
                alert('Selection area too small. Please select a larger area.');
                resetSelection();
                return;
            }

            ipcRenderer.send('debug-log', 'Area size validation passed');

            // Create area object with relative coordinates (no display offset needed)
            const area = {
                x: left,
                y: top,
                width: width,
                height: height
            };

            ipcRenderer.send('debug-log', 'Area object created: ' + JSON.stringify(area));

            // Update macro with area
            ipcRenderer.send('debug-log', 'Loading macros from store...');
            const macros = store.get('macros', []);
            ipcRenderer.send('debug-log', 'Current macros array: ' + JSON.stringify(macros));

            const macroIndex = macros.findIndex(m => m.id === currentMacroId);
            ipcRenderer.send('debug-log', 'Macro index found: ' + macroIndex);

            if (macroIndex !== -1) {
                ipcRenderer.send('debug-log', 'Updating macro at index ' + macroIndex + ' with area...');
                macros[macroIndex].area = area;

                ipcRenderer.send('debug-log', 'Saving updated macros to store...');
                store.set('macros', macros);
                ipcRenderer.send('debug-log', 'Macros saved successfully');

                ipcRenderer.send('debug-log', 'Sending IPC message to main process...');
                // Notify main process
                ipcRenderer.send('macro-area-assigned', currentMacroId, area);
                ipcRenderer.send('debug-log', 'IPC message sent: macro-area-assigned');

                ipcRenderer.send('debug-log', 'Closing overlay window...');
                // Close overlay
                window.close();
                ipcRenderer.send('debug-log', '=== CONFIRM SELECTION END ===');
            } else {
                ipcRenderer.send('debug-log', 'ERROR: Macro not found in array!');
                ipcRenderer.send('debug-log', 'Looking for macro ID: ' + currentMacroId);
                ipcRenderer.send('debug-log', 'Available macro IDs: ' + JSON.stringify(macros.map(m => m.id)));
            }
        }

        function resetSelection() {
            if (selectionBox) {
                selectionBox.remove();
                selectionBox = null;
            }
            coordinatesDiv.style.display = 'none';
            actionButtons.style.display = 'none';
            selectionState = 'waiting';

            // Reset instructions
            document.querySelector('.instructions').innerHTML = 'üì∑ Click to select start point ‚Ä¢ ESC to cancel';
        }

        function cancelSelection() {
            resetSelection();
            // Close overlay
            window.close();
        }

        function handleKeydown(e) {
            if (e.key === 'Escape') {
                if (selectionState === 'waiting') {
                    cancelSelection();
                } else {
                    resetSelection();
                }
            }
        }

        // Auto-focus for keyboard events
        window.focus();

        // Handle window close
        window.addEventListener('beforeunload', () => {
            ipcRenderer.send('area-selection-cancelled');
        });
    </script>
</body>
</html>
